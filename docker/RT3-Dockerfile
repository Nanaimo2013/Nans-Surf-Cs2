FROM        registry.gitlab.steamos.cloud/steamrt/sniper/platform:latest-container-runtime-depot
LABEL       author="Nans" maintainer="jmfcorp@jmfhosting.com"
LABEL       org.opencontainers.image.description="SteamRT3 Nans Platform image for CS2 Surf servers with fixes"
LABEL       org.opencontainers.image.source="https://github.com/nanaimo2013/Nans-Surf-Cs2"

# Prep OS
RUN         mkdir -p /etc/sudoers.d && \
            echo "%sudo ALL=(ALL:ALL) NOPASSWD: ALL" > /etc/sudoers.d/flatdeb && \
            chmod 0440 /etc/sudoers.d/flatdeb

ENV         DEBIAN_FRONTEND=noninteractive
RUN         apt update && apt install -y iproute2 && apt-get clean

USER        container
ENV         USER=container HOME=/home/container
WORKDIR     /home/container

# Create necessary directories
RUN         mkdir -p /home/container/game/csgo/cfg/sourcemod \
            /home/container/game/csgo/addons/sourcemod/plugins \
            /home/container/game/csgo/addons/sourcemod/configs \
            /home/container/game/csgo/addons/sourcemod/data

# Copy configuration files if they exist
COPY        --chown=container:container ./gamefiles/configs/core/ /home/container/game/csgo/cfg/
COPY        --chown=container:container ./gamefiles/configs/sourcemod/ /home/container/game/csgo/cfg/sourcemod/
COPY        --chown=container:container ./gamefiles/configs/sourcemod/surf/ /home/container/game/csgo/cfg/sourcemod/surf/

# Copy pre-compiled plugins
COPY        --chown=container:container ./gamefiles/plugins/compiled/ /home/container/game/csgo/addons/sourcemod/plugins/

# Copy entrypoint script
COPY        --chown=container:container ./docker/entrypoint.sh /entrypoint.sh
RUN         chmod +x /entrypoint.sh

# Set default environment variables for Pterodactyl
ENV         SRCDS_APPID=730 \
            SRCDS_PORT=25566 \
            SRCDS_MAXPLAYERS=24 \
            SRCDS_MAP="de_dust2" \
            SRCDS_VALIDATE=1 \
            DOWNLOAD_WORKSHOP_MAPS=0 \
            STEAM_ACC="anonymous"

CMD         [ "/bin/bash", "/entrypoint.sh" ]
