FROM        registry.gitlab.steamos.cloud/steamrt/sniper/platform:latest-container-runtime-depot
LABEL       author="Nans" maintainer="jmfcorp@jmfhosting.com"
LABEL       org.opencontainers.image.description="SteamRT3 Nans Platform image for CS2 Surf servers with fixes"
LABEL       org.opencontainers.image.source="https://github.com/nanaimo2013/Nans-Surf-Cs2"

# Prep OS
RUN         mkdir -p /etc/sudoers.d && \
            echo "%sudo ALL=(ALL:ALL) NOPASSWD: ALL" > /etc/sudoers.d/flatdeb && \
            chmod 0440 /etc/sudoers.d/flatdeb

ENV         DEBIAN_FRONTEND=noninteractive
RUN         apt update && \
            apt install -y \
            iproute2 \
            curl \
            tar \
            procps \
            lib32gcc1 \
            lib32stdc++6 \
            lib32ncurses6 \
            libcurl4-openssl-dev \
            libssl-dev \
            libsdl2-2.0-0 \
            libnm0 \
            ca-certificates \
            locales \
            tzdata \
            net-tools \
            iputils-ping \
            netcat \
            iptables \
            gcc \
            g++ \
            make \
            git \
            unzip \
            lib32z1 \
            python3 \
            build-essential && \
            apt-get clean

# Set up locales
RUN         locale-gen en_US.UTF-8
ENV         LANG=en_US.UTF-8 \
            LANGUAGE=en_US:en \
            LC_ALL=en_US.UTF-8

# Create container user and set up directories
RUN         useradd -m -d /home/container -s /bin/bash container && \
            mkdir -p /home/container/.steam/sdk32 && \
            mkdir -p /home/container/.steam/sdk64 && \
            mkdir -p /home/container/game/csgo/addons && \
            mkdir -p /home/container/game/csgo/cfg/sourcemod && \
            mkdir -p /home/container/game/csgo/materials && \
            mkdir -p /home/container/game/csgo/models && \
            mkdir -p /home/container/game/csgo/sound && \
            mkdir -p /home/container/game/csgo/addons/sourcemod/plugins && \
            mkdir -p /home/container/game/csgo/addons/sourcemod/data && \
            chown -R container:container /home/container

# Switch to container user
USER        container
ENV         USER=container HOME=/home/container
WORKDIR     /home/container

# Copy game files
COPY        --chown=container:container ./gamefiles/plugins/compiled/*.smx /home/container/game/csgo/addons/sourcemod/plugins/
COPY        --chown=container:container ./gamefiles/configs/core/* /home/container/game/csgo/cfg/
COPY        --chown=container:container ./gamefiles/configs/sourcemod/* /home/container/game/csgo/cfg/sourcemod/
COPY        --chown=container:container ./gamefiles/materials /home/container/game/csgo/materials/
COPY        --chown=container:container ./gamefiles/models /home/container/game/csgo/models/
COPY        --chown=container:container ./gamefiles/sound /home/container/game/csgo/sound/
COPY        --chown=container:container ./gamefiles/data /home/container/game/csgo/addons/sourcemod/data/
COPY        --chown=container:container ./docker/entrypoint.sh /entrypoint.sh

# Make scripts executable
RUN         chmod +x /entrypoint.sh

# Set default environment variables
ENV         SRCDS_APPID=730 \
            SRCDS_PORT=25566 \
            SRCDS_MAXPLAYERS=24 \
            SRCDS_MAP="workshop/2124557811/surf_beginner" \
            SRCDS_VALIDATE=1 \
            DOWNLOAD_WORKSHOP_MAPS=1 \
            COMPILE_PLUGINS=0

CMD         [ "/bin/bash", "/entrypoint.sh" ]
